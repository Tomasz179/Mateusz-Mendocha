<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sterownik â€“ Mateusz Mendocha</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root{--bg:#0d1117;--card:#161b22;--line:#30363d;--text:#c9d1d9;--muted:#8b949e;--ok:#2ea043;--err:#ffa657}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif}
    header{padding:18px 16px;border-bottom:1px solid var(--line);text-align:center}
    h1{margin:0;font-size:24px}
    .status{margin-top:6px;font-size:13px;color:var(--muted)}
    .wrap{max-width:1100px;margin:20px auto;padding:0 12px}
    .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px}
    .title{font-size:14px;color:#9cdcfe;margin:0 0 8px}
    .value{font-weight:700;font-size:22px}
    .unit{font-size:13px;color:var(--muted);margin-left:6px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .btn{padding:10px 14px;border:1px solid var(--line);background:#0b284f;color:#cfe6ff;border-radius:10px;cursor:pointer}
    .btn.off{background:#3a0b0b;color:#ffd2d2}
    .select{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#0b0f16;color:var(--text);width:100%}
    .input{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#0b0f16;color:var(--text);width:100%}
    .small{font-size:12px;color:var(--muted);margin-top:8px}
    .ok{color:var(--ok)} .err{color:var(--err)}

    /* Blokada hasÅ‚em */
    #lock{position:fixed;inset:0;background:#0b0f1a;display:flex;align-items:center;justify-content:center;z-index:9999}
    #lock .box{background:#111727;border:1px solid var(--line);color:var(--text);padding:22px;border-radius:12px;width:320px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    #lock h3{margin:0 0 10px}
    #lock input{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#0b0f16;color:var(--text);margin:10px 0}
    #lock button{width:100%;padding:10px;border:1px solid var(--line);border-radius:8px;background:#0b284f;color:#cfe6ff;cursor:pointer}
    #lock p{min-height:1.1em;font-size:13px;color:#ffb4a9;margin:8px 0 0}
  </style>
</head>
<body>
  <!-- BLOKADA HASÅEM -->
  <div id="lock">
    <div class="box">
      <h3>ğŸ” DostÄ™p chroniony</h3>
      <input id="pwd" type="password" placeholder="HasÅ‚o" autocomplete="current-password" />
      <button id="unlockBtn">Odblokuj</button>
      <p id="lockMsg"></p>
    </div>
  </div>

  <header>
    <h1>ğŸŒ¬ï¸ Sterownik â€“ Mateusz Mendocha</h1>
    <div id="mqttStatus" class="status">MQTT: Å‚Ä…czenieâ€¦</div>
  </header>

  <div class="wrap">
    <div class="cards">
      <div class="card">
        <p class="title">Wiatrak (energia)</p>
        <div class="value"><span id="kwh">â€”</span><span class="unit">kWh</span></div>
      </div>
      <div class="card">
        <p class="title">Moc Å‚adowania</p>
        <div class="value"><span id="power">â€”</span><span class="unit">W</span></div>
      </div>
      <div class="card">
        <p class="title">NaÅ‚adowanie baterii</p>
        <div class="value"><span id="soc">â€”</span><span class="unit">%</span></div>
      </div>
      <div class="card">
        <p class="title">NapiÄ™cie baterii</p>
        <div class="value"><span id="bat_v">â€”</span><span class="unit">V</span></div>
      </div>
      <div class="card">
        <p class="title">PrÄ…d Å‚adowania</p>
        <div class="value"><span id="bat_a">â€”</span><span class="unit">A</span></div>
      </div>
    </div>

    <div class="cards" style="margin-top:12px;">
      <div class="card">
        <p class="title">Hamulec turbiny</p>
        <div class="row">
          <div class="value" id="brakeState">â€”</div>
          <button class="btn" id="btnBrake">PrzeÅ‚Ä…cz</button>
        </div>
      </div>

      <div class="card">
        <p class="title">WyjÅ›cie LOAD</p>
        <div class="row">
          <div class="value" id="loadState">â€”</div>
          <button class="btn" id="btnLoad">PrzeÅ‚Ä…cz</button>
        </div>
      </div>

      <div class="card">
        <p class="title">Tryb napiÄ™cia systemu</p>
        <div class="row">
          <select id="selSystem" class="select">
            <option>Auto</option>
            <option>24V</option>
            <option>48V</option>
          </select>
          <button class="btn" id="btnSaveSystem">Zapisz</button>
        </div>
        <div class="small" id="currSystem">BieÅ¼Ä…cy tryb: â€”</div>
      </div>

      <div class="card">
        <p class="title">Typ baterii</p>
        <div class="row">
          <select id="selBattery" class="select">
            <option>B0</option><option>B1</option><option>B2</option><option>B3</option><option>B4</option>
          </select>
          <button class="btn" id="btnSaveBatt">Zapisz</button>
        </div>
        <div class="small" id="currBatt">BieÅ¼Ä…cy typ: â€”</div>
      </div>

      <div class="card">
        <p class="title">Battery Full Voltage</p>
        <div class="row" style="gap:8px;">
          <input id="numFull" class="input" type="number" step="0.1" min="20" max="72" placeholder="np. 55.2" />
          <button class="btn" id="btnSaveFull">Zapisz</button>
        </div>
        <div class="small" id="currFull">BieÅ¼Ä…ca wartoÅ›Ä‡: â€”</div>
      </div>
    </div>
  </div>

<script>
/* ===== BLOKADA HASÅEM ===== */
const PASSWORD = "FEH2025";
const lockEl = document.getElementById("lock");
const lockMsg = document.getElementById("lockMsg");
function unlockWith(v){
  const ok = String(v||"").trim() === PASSWORD;
  if(ok){ lockEl.style.display="none"; startApp(); }
  else { lockMsg.textContent = "âŒ ZÅ‚e hasÅ‚o"; }
  return ok;
}
document.getElementById("unlockBtn").onclick = ()=>unlockWith(document.getElementById("pwd").value);
document.getElementById("pwd").onkeydown = (e)=>{ if(e.key==="Enter") unlockWith(e.target.value); };

/* ===== APLIKACJA ===== */
function startApp(){
  const MQTT_URL  = "wss://broker.hivemq.com:8884/mqtt";
  const PREFIX    = "mateusz mendocha";   // dokÅ‚adnie jak w YAML
  const CLIENT_ID = "webdash_"+Math.random().toString(16).slice(2);

  const els = {
    kwh: qs("#kwh"), power: qs("#power"), soc: qs("#soc"),
    bat_v: qs("#bat_v"), bat_a: qs("#bat_a"),
    brakeState: qs("#brakeState"), btnBrake: qs("#btnBrake"),
    loadState: qs("#loadState"), btnLoad: qs("#btnLoad"),
    selSystem: qs("#selSystem"), btnSaveSystem: qs("#btnSaveSystem"), currSystem: qs("#currSystem"),
    selBattery: qs("#selBattery"), btnSaveBatt: qs("#btnSaveBatt"), currBatt: qs("#currBatt"),
    numFull: qs("#numFull"), btnSaveFull: qs("#btnSaveFull"), currFull: qs("#currFull"),
    mqttStatus: qs("#mqttStatus")
  };
  function qs(s){return document.querySelector(s)}
  function parseNumber(val){const m=String(val).match(/-?\d+(?:[.,]\d+)?/);return m?parseFloat(m[0].replace(',','.')):NaN}
  function fmt(n,dec=1){return Number.isFinite(n)?(n.toFixed(dec).replace(".",",")):"â€”"}

  // normalizacja (polskie znaki â†’ ASCII, reszta na "_")
  function norm(s){
    return String(s)
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // usuÅ„ diakrytyki
      .replace(/[^a-z0-9/]+/g,'_')                    // wszystko inne â†’ _
      .replace(/_+/g,'_');
  }

  // Detektory tematÃ³w (bardzo tolerancyjne)
  const isBattVoltage = (t) => {
    // zÅ‚apie np.: .../sensor/napi__cie_baterii/state, .../sensor/battery_voltage/state
    return t.includes("/sensor/") && (
      (t.includes("napi") && (t.includes("bater") || t.includes("batt") || t.includes("bat"))) ||
      (t.includes("battery") && (t.includes("volt") || t.includes("voltage")))
    );
  };
  const isChargeCurrent = (t) => {
    // zÅ‚apie np.: .../sensor/pr__d___adowania/state, .../sensor/charging_current/state
    return t.includes("/sensor/") && (
      (t.includes("prad") && (t.includes("ladowan") || t.includes("adowan"))) ||
      (t.includes("current") && (t.includes("charg") || t.includes("charge")))
    );
  };

  // MQTT
  const client = mqtt.connect(MQTT_URL, { clientId: CLIENT_ID, clean:true, reconnectPeriod:3000 });
  client.on("connect", ()=>{ els.mqttStatus.innerHTML='MQTT: <span class="ok">poÅ‚Ä…czono</span>'; client.subscribe(`${PREFIX}/#`); });
  client.on("reconnect", ()=> els.mqttStatus.textContent="MQTT: ponawianieâ€¦");
  client.on("close", ()=> els.mqttStatus.innerHTML='MQTT: <span class="err">rozÅ‚Ä…czono</span>');
  client.on("error", ()=> els.mqttStatus.innerHTML='MQTT: <span class="err">bÅ‚Ä…d</span>');

  function pub(topic,payload){ client.publish(topic, String(payload), { qos:0, retain:false }); }

  let topics = {
    wiatrak_kwh:null, moc_ladowania:null, procent_soc:null,
    napiecie_batt:null, prad_ladowania:null,
    hamulec_state:null, hamulec_cmd:null, load_state:null, load_cmd:null,
    system_state:null, system_cmd:null, battery_state:null, battery_cmd:null,
    full_state:null, full_cmd:null
  };

  client.on("message",(topic,payloadBuf)=>{
    const payload = payloadBuf.toString();
    const t = norm(topic);
    if(!t.endsWith("/state")) return;

    // Sensory
    if (t.includes("/sensor/")) {
      if(t.includes("wiatrak") && t.includes("kwh")) { topics.wiatrak_kwh=topic; els.kwh.textContent=fmt(parseNumber(payload),1); return; }
      if(t.includes("moc") && (t.includes("ladowan")||t.includes("adowan"))) { topics.moc_ladowania=topic; els.power.textContent=fmt(parseNumber(payload),1); return; }
      if((t.includes("procent")||t.includes("soc")) && (t.includes("bater")||t.includes("batt")||t.includes("bat"))) { topics.procent_soc=topic; els.soc.textContent=fmt(parseNumber(payload),1); return; }

      // NOWE: napiÄ™cie baterii & prÄ…d Å‚adowania
      if(isBattVoltage(t)) { topics.napiecie_batt=topic; els.bat_v.textContent=fmt(parseNumber(payload),1); return; }
      if(isChargeCurrent(t)) { topics.prad_ladowania=topic; els.bat_a.textContent=fmt(parseNumber(payload),1); return; }
    }

    // PrzeÅ‚Ä…czniki
    if (t.includes("/switch/")) {
      if(t.includes("hamulec")) {
        topics.hamulec_state = topic;
        topics.hamulec_cmd = topic.replace(/\/state$/,"/command");
        setSwitchUI(els.brakeState, els.btnBrake, payload);
        return;
      }
      if(t.includes("load") || t.includes("wyjscie")) {
        topics.load_state = topic;
        topics.load_cmd = topic.replace(/\/state$/,"/command");
        setSwitchUI(els.loadState, els.btnLoad, payload);
        return;
      }
    }

    // Selecty
    if (t.includes("/select/")) {
      if(t.includes("tryb") || t.includes("systemu") || t.includes("napiecia")) {
        topics.system_state = topic;
        topics.system_cmd = topic.replace(/\/state$/,"/command");
        els.currSystem.textContent = "BieÅ¼Ä…cy tryb: "+payload;
        return;
      }
      if(t.includes("typ") && t.includes("baterii")) {
        topics.battery_state = topic;
        topics.battery_cmd = topic.replace(/\/state$/,"/command");
        els.currBatt.textContent = "BieÅ¼Ä…cy typ: "+payload;
        return;
      }
    }

    // Number
    if (t.includes("/number/") && t.includes("battery_full_voltage")) {
      topics.full_state = topic;
      topics.full_cmd = topic.replace(/\/state$/,"/command");
      const v = parseNumber(payload);
      if(Number.isFinite(v)) els.currFull.textContent = "BieÅ¼Ä…ca wartoÅ›Ä‡: "+fmt(v,1)+" V";
    }
  });

  function setSwitchUI(labelEl, btnEl, state){
    const on = String(state).toUpperCase()==="ON";
    labelEl.textContent = on ? "WÅ‚Ä…czone" : "WyÅ‚Ä…czone";
    btnEl.classList.toggle("off", on);
    btnEl.textContent = "PrzeÅ‚Ä…cz";
  }

  // Klik â€“ hamulec
  els.btnBrake.onclick = ()=>{
    if(!topics.hamulec_cmd || !topics.hamulec_state) return;
    const curr = els.brakeState.textContent.includes("WÅ‚Ä…czone");
    pub(topics.hamulec_cmd, curr ? "OFF" : "ON");
  };
  // Klik â€“ LOAD
  els.btnLoad.onclick = ()=>{
    if(!topics.load_cmd || !topics.load_state) return;
    const curr = els.loadState.textContent.includes("WÅ‚Ä…czone");
    pub(topics.load_cmd, curr ? "OFF" : "ON");
  };
  // Zapis trybu napiÄ™cia systemu
  els.btnSaveSystem.onclick = ()=>{ if(topics.system_cmd) pub(topics.system_cmd, els.selSystem.value); };
  // Zapis typu baterii
  els.btnSaveBatt.onclick   = ()=>{ if(topics.battery_cmd) pub(topics.battery_cmd, els.selBattery.value); };
  // Zapis battery full voltage
  els.btnSaveFull.onclick   = ()=>{
    if(!topics.full_cmd) return;
    const v = parseNumber(els.numFull.value);
    if(Number.isFinite(v)) pub(topics.full_cmd, v.toFixed(1));
  };
}
</script>
</body>
</html>
